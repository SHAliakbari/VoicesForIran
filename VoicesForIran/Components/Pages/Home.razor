@page "/"
@using VoicesForIran.Core.Interfaces
@using VoicesForIran.Core.Models
@inject IMPLookupService MpLookupService
@inject IMailtoGenerator MailtoGenerator
@inject ITemplateProvider TemplateProvider
@inject IEmailLogRepository EmailLogRepository
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

@using VoicesForIran.Components.Home

<PageTitle>Voices for Iran - Contact Your Representatives</PageTitle>

<HeroSection />

<ContextSection />

<!-- Main Form Section -->
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-7 col-xl-6">
                <EmailFormCard Model="@_formModel" OnValidSubmit="HandleSubmit" IsLoading="@_isLoading" ErrorMessage="@_errorText" />

                @if (_lookupResult is not null && _lookupResult.HasAnyRepresentatives)
                {
                    <RepresentativesPicker Representatives="@_lookupResult.Representatives"
                                           Selected="@_selectedRepresentatives"
                                           OnToggle="HandleToggleRepresentative"
                                           OnGenerate="GenerateEmails"
                                           OnSelectAll="HandleSelectAll"
                                           OnDeselectAll="HandleDeselectAll" />

                    <GeneratedEmailsList Emails="@_generatedEmails" CopiedEmailId="@_copiedEmailId" OnCopy="CopyEmailToClipboard" />
                }

                <!-- Privacy Notice -->
                <div class="card mt-4 border-0 bg-light rounded-4">
                    <div class="card-body text-center py-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-white rounded-circle p-3 mb-3 shadow-sm">
                            <i class="bi bi-shield-lock text-success fs-4"></i>
                        </div>
                        <h4 class="h6 mb-2">Privacy First</h4>
                        <p class="small text-muted mb-0">
                            We <strong>never</strong> store your name, postal code, or any personal information.
                            Only aggregate statistics (riding, MP name) are logged for our
                            <a href="/impact" class="text-decoration-none">impact dashboard</a>.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private EmailFormModel _formModel = new();
    private RepresentativeLookupResult? _lookupResult;
    private string? _errorText;
    private bool _isLoading;
    private HashSet<Representative> _selectedRepresentatives = new();
    private List<GeneratedEmailsList.GeneratedEmailVm> _generatedEmails = new();
    private int? _copiedEmailId;

    private async Task HandleSubmit()
    {
        _errorText = null;
        _lookupResult = null;
        _selectedRepresentatives.Clear();
        _generatedEmails.Clear();
        _copiedEmailId = null;
        _isLoading = true;

        try
        {
            // Look up representatives
            _lookupResult = await MpLookupService.LookupByPostalCodeAsync(_formModel.PostalCode ?? "");

            if (!_lookupResult.HasAnyRepresentatives)
            {
                _errorText = "No representatives found for this postal code. Please check the postal code and try again.";
                return;
            }

            if (!_lookupResult.HasEmailableRepresentatives)
            {
                _errorText = "Representatives were found, but none have public email addresses available.";
                return;
            }

            // Pre-select all emailable representatives
            _selectedRepresentatives = _lookupResult.EmailableRepresentatives.ToHashSet();
        }
        catch (Exception ex)
        {
            _errorText = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ApplyToggle(Representative rep, bool isSelected)
    {
        if (isSelected)
            _selectedRepresentatives.Add(rep);
        else
            _selectedRepresentatives.Remove(rep);
    }

    private Task HandleToggleRepresentative((Representative Rep, bool IsSelected) args)
    {
        ApplyToggle(args.Rep, args.IsSelected);
        return Task.CompletedTask;
    }

    private Task HandleSelectAll(List<Representative> reps)
    {
        foreach (var rep in reps)
            _selectedRepresentatives.Add(rep);
        return Task.CompletedTask;
    }

    private Task HandleDeselectAll(List<Representative> reps)
    {
        foreach (var rep in reps)
            _selectedRepresentatives.Remove(rep);
        return Task.CompletedTask;
    }

    private async Task CopyEmailToClipboard(GeneratedEmailsList.GeneratedEmailVm email)
    {
        try
        {
            var emailContent = $"Subject: {email.ProcessedTemplate.Subject}\n\n{email.ProcessedTemplate.Body}";
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", emailContent);

            _copiedEmailId = email.CopyKey;

            // Reset the copied state after 2 seconds
            _ = Task.Delay(2000).ContinueWith(_ =>
            {
                _copiedEmailId = null;
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            _errorText = $"Failed to copy to clipboard: {ex.Message}";
        }
    }

    private async Task GenerateEmails()
    {
        _generatedEmails.Clear();
        _errorText = null;

        try
        {
            foreach (var rep in _selectedRepresentatives)
            {
                // Get targeted template for this representative
                var template = TemplateProvider.GetTargetedTemplate(rep);

                var ridingOrRegion = rep.DistrictName ?? (rep.PrefersFrench ? "votre circonscription" : "your riding");
                var representativeFullName = string.IsNullOrWhiteSpace(rep.Honorific)
                    ? rep.Name
                    : $"{rep.Honorific} {rep.Name}";

                // Replace placeholders with actual values
                var variables = new Dictionary<string, string>
                {
                    ["RepresentativeTitle"] = $"{rep.ElectedOffice} {rep.Name}",
                    ["RepresentativeName"] = rep.Name,
                    ["RepresentativeOffice"] = rep.ElectedOffice,
                    ["RidingName"] = ridingOrRegion,
                    ["RidingOrRegion"] = ridingOrRegion,
                    ["RepresentativeFullName"] = representativeFullName,
                    ["PartyName"] = rep.Party ?? "",
                    ["PostalCode"] = _formModel.PostalCode?.ToUpperInvariant() ?? "",
                    ["UserName"] = _formModel.UserName ?? "A concerned constituent",
                    ["Honorific"] = rep.Honorific
                };
                var processedTemplate = template.WithVariables(variables);

                // Create a temporary lookup result with just this representative
                var singleRepResult = new RepresentativeLookupResult
                {
                    PostalCode = _lookupResult!.PostalCode,
                    Representatives = new List<Representative> { rep }
                };

                // Generate mailto link for this representative
                var mailtoLink = MailtoGenerator.GenerateMailtoLink(singleRepResult, processedTemplate, _formModel.UserName);

                _generatedEmails.Add(new GeneratedEmailsList.GeneratedEmailVm
                {
                    Representative = rep,
                    ProcessedTemplate = processedTemplate,
                    MailtoLink = mailtoLink,
                    TemplateName = GetFriendlyTemplateName(template.FileName),
                    CopyKey = (rep.Name.GetHashCode(), rep.ElectedOffice.GetHashCode()).GetHashCode()
                });

                // Log for impact dashboard (only MP name and riding - NO user data)
                await EmailLogRepository.LogEmailGenerationAsync(
                    rep.Name,
                    rep.DistrictName ?? "Unknown Riding");
            }
        }
        catch (Exception ex)
        {
            _errorText = $"An error occurred while generating emails: {ex.Message}";
        }
    }

    private static string GetFriendlyTemplateName(string fileName)
    {
        // Remove path and extension, make it friendly
        var name = Path.GetFileNameWithoutExtension(fileName);

        // Convert kebab-case to Title Case
        name = string.Join(" ", name.Split('-', '_')

                        .Select(word => word.Length > 0
                ? char.ToUpper(word[0]) + (word.Length > 1 ? word[1..] : string.Empty)
                : string.Empty));


        return name;
    }

}
